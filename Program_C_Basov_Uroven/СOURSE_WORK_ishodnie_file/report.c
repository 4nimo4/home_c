/*
    report.c

    Описание:
    Программа для обработки статистики температур по данным из CSV-файла.
    Хранит данные в массиве структур sensor_t и выводит:
    - При запуске без параметров:
        краткую информацию и предложение использовать ключ -h.
    - Ключ -h:
        описание поддерживаемых ключей запуска и их назначение.
    - Ключ -f <filename.csv>:
        считывание данных из указанного файла CSV и вывод полной статистики
        по всем месяцам года в виде таблицы:
        ========================================================
        Line YEAR MONTH MinTemp MaxTemp AvgTemp
        1    2021 1     ...
        ...
        а также сводной статистики за год (средняя, минимальная, максимальная температуры).
    - Ключ -f <filename.csv> -m <номер месяца>:
        считывание данных из файла CSV и вывод статистики только
        за указанный месяц (min, max, avg) в виде одной строки таблицы.
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>   // Функция getopt для разбора аргументов командной строки
#include "temp_function.h"

//--------------------------------------------------------------------
// Внешние переменные библиотеки getopt
//--------------------------------------------------------------------
// optarg – указатель на строку с параметром текущего ключа,
//          заполняется автоматически при разборе аргументов:
//          например, для "-f file.csv" optarg указывает на "file.csv",
//          для "-m 3"  optarg указывает на "3".
// optind – индекс следующего аргумента в argv[], который будет обработан.
//          Используется самой функцией getopt как внутренний счётчик.
//--------------------------------------------------------------------
extern char *optarg;
extern int   optind;

int main(int argc, char *argv[])
{
    sensor_t data[SIZE];      // Массив структур для хранения считанных из файла данных
    int n = 0;                // Количество реально загруженных записей

    int rez;                  // Переменная для результата функции getopt
    char *filename = NULL;    // Имя входного CSV-файла
    int month_filter = 0;     // month_filter = 0 – фильтра по месяцу нет;
                        // при заданном ключе -m сюда записывается номер месяца (1-12)
    int have_f = 0;           // Флаг наличия ключа -f
    int have_m = 0;           // Флаг наличия ключа -m

    //------------------------------------------------------------
    // Если программа запущена без параметров – выводим краткую
    // информацию и предлагаем воспользоваться ключом -h
    //------------------------------------------------------------
    if (argc == 1)//argv[0] == "./prog"
    {
        printf("Программа для обработки статистики температур.\n");
        printf("Для получения справки по ключам используйте: %s -h\n", argv[0]);
        return 0;
    }

    //------------------------------------------------------------
    // Обрабатываем ключи командной строки с помощью getopt:
    // поддерживаются -h, -f, -m
    //------------------------------------------------------------
    while ((rez = getopt(argc, argv, "hf:m:")) != -1)//Пока в командной строке есть ещё ключи из списка(!=-1)
                                                     //— обрабатываем их по одному
    {
        switch (rez)
        {
            //--------------------------------------------
            // Ключ -h: вывод справочной информации
            //--------------------------------------------
            case 'h':
                printf("Список поддерживаемых ключей:\n"
                       " -h                 справка по ключам\n"
                       " -f <filename.csv>  входной CSV-файл для обработки\n"
                       " -m <номер месяца>  статистика только за указанный месяц (1-12)\n"
                       "Примеры:\n"
                       "  %s -h\n"
                       "  %s -f temperature_small.csv\n"
                       "  %s -f temperature_big.csv -m 3\n",
                       argv[0], argv[0], argv[0]);
                return 0;

            //--------------------------------------------
            // Ключ -f: запоминаем имя входного файла
            //--------------------------------------------
            case 'f':
                filename = optarg;
                have_f = 1;
                break;

            //--------------------------------------------
            // Ключ -m: запоминаем номер месяца для фильтрации
            //--------------------------------------------
            case 'm':
                month_filter = atoi(optarg);
                if (month_filter < 1 || month_filter > 12)
                {
                    printf("Некорректный номер месяца: %s\n", optarg);
                    return 1;
                }
                have_m = 1;
                break;

            //--------------------------------------------
            // Неизвестный ключ – выводим подсказку
            //--------------------------------------------
            default:
                printf("Неизвестный ключ. Используйте %s -h для справки.\n", argv[0]);
                return 1;
        }
    }

    //------------------------------------------------------------
    // Проверяем, что ключ -f с именем файла действительно был указан
    //------------------------------------------------------------
    if (!have_f)
    {
        printf("Не указан входной файл. Используйте: %s -f <filename.csv>\n", argv[0]);
        return 1;
    }

    //------------------------------------------------------------
    // Считываем CSV-файл в массив data[] и получаем количество
    // корректно загруженных записей n
    //------------------------------------------------------------
    n = load_temperature_csv(data, SIZE, filename);
    if (n <= 0)
    {
        printf("Нет корректных данных в файле %s\n", filename);
        return 1;
    }

    //------------------------------------------------------------
    // По условию задания считаем, что данные относятся к одному году.
    // Определяем год по первой записи массива.
    //------------------------------------------------------------
    int year = data[0].year;

    //------------------------------------------------------------
    // Если указан ключ -m, выводим статистику только за один месяц,
    // иначе выводим полную таблицу по всем 12 месяцам и сводку за год.
    //------------------------------------------------------------
    if (have_m)//Если ключ -m вообще есть
    {
        // Статистика только за указанный месяц
         // есть ключ -m → печатаем только один месяц month_filter
        print_shap_zagolovka();
        if (!print_month_stat_line(data, n, year, month_filter, 1))// если == 0
        /*
        data — массив всех считанных записей;
        n — количество корректных записей;
        year — год (берём из data[0].year)
        month_filter — номер месяца, который ввёл пользователь (-m N)
        1 — номер строки в таблице (Line), так как для режима -m у нас всегда одна строка.
        Функция print_month_stat_line внутри вызывает get_month_stats(...) для указанного
        year и month, если данные есть считает min, max, avg, печатает строку в нужном формате,
        возвращает 1. если данных нет , ничего не печатает, возвращает 0 
        */
        {
            printf("Нет данных за %d-%02d\n", year, month_filter);
        }
    }
    else
    {
        // Полная статистика по всем месяцам + итог за год
         // нет ключа -m → печатаем все месяцы
        print_year_table(data, n, year);
    }

    return 0;
}